# xcert-rs: Rust X509 Certificate Utility

[![CI](https://github.com/sweis/xcert-rs/actions/workflows/ci.yml/badge.svg)](https://github.com/sweis/xcert-rs/actions/workflows/ci.yml)

> **Warning:** This project was generated by Claude. Review all
> code carefully before using in production. The implementation has not been
> audited by human security experts.

A fast, memory-safe command-line tool for inspecting X.509 certificates.
Designed as a modern replacement for `openssl x509` with a simpler interface,
JSON output, and subcommand-based CLI.

`xcert` is read-only -- it parses and displays certificates but does not sign
or create them.

## Features

- **Auto-detection** of PEM vs DER format (no `-inform` flag needed)
- **Subcommand-based CLI** (`show`, `field`, `check`, `convert`, `verify`)
- **JSON output** with `--json` for scripting and machine consumption
- **Certificate chain verification** against the system trust store (same CA
  bundle as OpenSSL) or a custom CA file, with hostname matching
- **Certificate checks** for expiry, hostname, email, and IP matching
- **Directory batch mode** with parallel processing via [rayon](https://docs.rs/rayon)
  -- pass a directory instead of a file to `check` or `verify`
- **SHA-256/384/512/SHA-1** fingerprint computation
- **RSA, ECDSA (P-256/P-384/P-521), Ed25519** key types
- **Memory-safe** Rust implementation with `unsafe` code forbidden at the
  workspace level

## Build

Requires Rust 1.70+.

```bash
# Debug build
cargo build

# Release build (recommended for benchmarks and production use)
cargo build --release
```

The release binary is at `target/release/xcert`.

### Install locally

```bash
cargo install --path xcert
```

### Run tests

```bash
cargo test
```

There are 210 integration tests covering parsing, field extraction, extensions,
fingerprints, checks, conversion, display, degenerate/malformed inputs,
certificate chain verification, verify options (email, IP, time, purpose,
depth, partial chain), Name Constraints, CRL revocation checking,
cross-compatibility with external test vectors, and OpenSSL output format
compatibility.

## Usage

### `xcert show` -- Display certificate information

```bash
# Display a PEM certificate (equivalent to: openssl x509 -text -noout -in cert.pem)
xcert show cert.pem

# Display a DER certificate
xcert show cert.der

# JSON output
xcert show --json cert.pem

# Include signature bytes
xcert show --all cert.pem

# Read from stdin
cat cert.pem | xcert show
```

### `xcert field` -- Extract a single field

```bash
# Subject (equivalent to: openssl x509 -subject -noout -in cert.pem)
xcert field subject cert.pem

# Issuer
xcert field issuer cert.pem

# Serial number
xcert field serial cert.pem

# Validity dates
xcert field not-before cert.pem
xcert field not-after cert.pem

# SHA-256 fingerprint (default)
xcert field fingerprint cert.pem

# SHA-384 fingerprint
xcert field fingerprint --digest sha384 cert.pem

# Public key in PEM format
xcert field public-key cert.pem

# RSA modulus
xcert field modulus cert.pem

# Email addresses from subject and SAN
xcert field emails cert.pem

# Subject Alternative Names
xcert field san cert.pem

# SAN as JSON
xcert field san --json cert.pem

# OCSP responder URLs
xcert field ocsp-url cert.pem

# Key Usage / Extended Key Usage
xcert field key-usage cert.pem
xcert field ext-key-usage cert.pem

# All extensions
xcert field extensions cert.pem

# Filter a specific extension by name or OID (like openssl x509 -ext)
xcert field extensions --ext subjectAltName cert.pem
xcert field extensions --ext "Key Usage" cert.pem
```

### `xcert check` -- Validate certificate properties

Returns exit code 0 for pass, 1 for fail. Useful in scripts and CI.

The `expiry` check accepts durations in [humantime](https://docs.rs/humantime)
format. Plain numbers default to seconds. Supported units include `s` (seconds),
`m`/`min` (minutes), `h`/`hr` (hours), `d`/`day` (days), `w`/`week` (weeks),
`month` (months), and `y`/`year` (years). Units can be combined: `1h30m`,
`2d12h`, `1w3d`.

```bash
# Check if cert expires within 30 days
xcert check expiry 30d cert.pem

# Same check in seconds (backwards compatible)
xcert check expiry 2592000 cert.pem

# Check if cert is valid for at least 1 week
xcert check expiry 1w cert.pem

# Combined units: valid for 2 hours and 30 minutes?
xcert check expiry 2h30m cert.pem

# Check hostname match (RFC 6125 with wildcard support)
xcert check host www.example.com cert.pem

# Check email match
xcert check email user@example.com cert.pem

# Check IP match (IPv4 and IPv6)
xcert check ip 93.184.216.34 cert.pem

# Use in a script
if xcert check expiry 7d cert.pem; then
  echo "Certificate valid for at least 7 more days"
else
  echo "Certificate expires within 7 days!"
fi

# Check all certs in a directory (parallel)
xcert check expiry 30d /etc/ssl/certs/

# Only show failures
xcert check expiry 7d --failures-only /etc/ssl/certs/

# Recurse into subdirectories
xcert check expiry 30d -r /opt/certs/
```

### `xcert convert` -- Convert between formats

```bash
# PEM to DER (format inferred from output extension)
xcert convert cert.pem cert.der

# DER to PEM
xcert convert cert.der cert.pem

# Explicit format flag (required when writing to stdout)
xcert convert cert.pem --to der > cert.der

# Pipe through stdin
cat cert.pem | xcert convert --to der > cert.der
```

### `xcert verify` -- Verify a certificate chain

```bash
# Verify a full chain (leaf + intermediates + root) against system trust store
xcert verify chain.pem

# Verify with hostname checking
xcert verify --hostname www.example.com chain.pem

# Use a custom CA file instead of the system trust store
xcert verify --CAfile my-ca.pem chain.pem

# Add additional trusted CA directory
xcert verify --CApath /etc/ssl/extra-certs chain.pem

# Separate leaf and intermediates (like openssl verify -untrusted)
xcert verify --untrusted intermediates.pem leaf.pem

# Check Extended Key Usage purpose (sslserver, sslclient, smimesign, codesign, any, or OID)
xcert verify --purpose sslserver chain.pem

# Allow partial chain (trust any cert in the chain, not just root)
xcert verify --partial-chain chain.pem

# Skip validity date checks (useful for testing expired certs)
xcert verify --no-check-time chain.pem

# Verify at a specific time (Unix timestamp)
xcert verify --attime 1700000000 chain.pem

# Limit chain depth
xcert verify --verify-depth 3 chain.pem

# Verify email or IP against the leaf certificate
xcert verify --verify-email user@example.com chain.pem
xcert verify --verify-ip 93.184.216.34 chain.pem

# Show the verified chain details
xcert verify --show-chain chain.pem

# JSON output
xcert verify --json chain.pem

# Read from stdin
cat chain.pem | xcert verify

# Verify all certs in a directory (parallel)
xcert verify --CAfile ca.pem /etc/ssl/certs/

# Only show failures
xcert verify --failures-only /etc/ssl/certs/

# Recurse into subdirectories
xcert verify -r /opt/certs/
```

Exit code 0 means verification passed, exit code 2 means verification failed.

### Comparison with OpenSSL

| OpenSSL | xcert |
|---|---|
| `openssl x509 -text -noout -in cert.pem` | `xcert show cert.pem` |
| `openssl x509 -subject -noout -in cert.pem` | `xcert field subject cert.pem` |
| `openssl x509 -issuer -noout -in cert.pem` | `xcert field issuer cert.pem` |
| `openssl x509 -serial -noout -in cert.pem` | `xcert field serial cert.pem` |
| `openssl x509 -dates -noout -in cert.pem` | `xcert field not-before` / `not-after` |
| `openssl x509 -fingerprint -sha256 -noout -in cert.pem` | `xcert field fingerprint cert.pem` |
| `openssl x509 -pubkey -noout -in cert.pem` | `xcert field public-key cert.pem` |
| `openssl x509 -modulus -noout -in cert.pem` | `xcert field modulus cert.pem` |
| `openssl x509 -email -noout -in cert.pem` | `xcert field emails cert.pem` |
| `openssl x509 -ext subjectAltName -noout -in cert.pem` | `xcert field san cert.pem` |
| `openssl x509 -ocsp_uri -noout -in cert.pem` | `xcert field ocsp-url cert.pem` |
| `openssl x509 -checkend 3600 -noout -in cert.pem` | `xcert check expiry 1h cert.pem` |
| `openssl x509 -checkhost foo.com -noout -in cert.pem` | `xcert check host foo.com cert.pem` |
| `openssl x509 -checkip 1.2.3.4 -noout -in cert.pem` | `xcert check ip 1.2.3.4 cert.pem` |
| `openssl x509 -checkemail a@b.com -noout -in cert.pem` | `xcert check email a@b.com cert.pem` |
| `openssl x509 -outform DER -in c.pem -out c.der` | `xcert convert c.pem c.der` |
| `openssl verify chain.pem` | `xcert verify chain.pem` |
| `openssl verify -CAfile ca.pem cert.pem` | `xcert verify --CAfile ca.pem cert.pem` |
| `openssl verify -CApath /dir cert.pem` | `xcert verify --CApath /dir cert.pem` |
| `openssl verify -untrusted int.pem leaf.pem` | `xcert verify --untrusted int.pem leaf.pem` |
| `openssl verify -partial_chain cert.pem` | `xcert verify --partial-chain cert.pem` |
| `openssl verify -purpose sslserver cert.pem` | `xcert verify --purpose sslserver cert.pem` |
| `openssl verify -attime 1700000000 cert.pem` | `xcert verify --attime 1700000000 cert.pem` |
| `openssl verify -verify_depth 3 cert.pem` | `xcert verify --verify-depth 3 cert.pem` |

## Benchmarks

All benchmarks run 1000 iterations measuring wall-clock time (including process
startup). Environment: Linux 4.4.0, OpenSSL 3.0.13.

### Results: xcert vs OpenSSL

| Operation | OpenSSL avg (ms) | xcert avg (ms) | Speedup |
|---|--:|--:|--:|
| Parse + text display (root-ca.pem) | 43.27 | 10.29 | 4.2x |
| Parse + text display (server.pem) | 43.83 | 10.23 | 4.3x |
| Parse + text display (many-extensions.pem) | 43.90 | 10.41 | 4.2x |
| Subject extraction (root-ca.pem) | 44.09 | 10.72 | 4.1x |
| Subject extraction (server.pem) | 44.33 | 10.21 | 4.3x |
| Subject extraction (many-extensions.pem) | 44.78 | 10.55 | 4.2x |
| SHA-256 fingerprint (root-ca.pem) | 42.50 | 10.51 | 4.0x |
| SHA-256 fingerprint (server.pem) | 42.27 | 10.61 | 4.0x |
| SHA-256 fingerprint (many-extensions.pem) | 43.32 | 11.69 | 3.7x |
| PEM to DER (root-ca.pem) | 43.07 | 10.78 | 4.0x |
| PEM to DER (server.pem) | 43.70 | 10.07 | 4.3x |
| PEM to DER (many-extensions.pem) | 43.65 | 9.86 | 4.4x |
| DER parse + text display (root-ca.der) | 43.30 | 9.59 | 4.5x |
| Hostname check (server.pem) | 43.14 | 9.86 | 4.4x |

**Summary:** xcert is **3.7x -- 4.5x faster** than `openssl x509` across all
operations. Both tools are dominated by process startup overhead, but the xcert
binary is significantly lighter (~4 MB static vs OpenSSL's dynamic linking and
larger initialization path).

### Running benchmarks yourself

**OpenSSL baseline:**

```bash
bash bench/openssl-baseline.sh
```

**xcert benchmarks:**

```bash
# Build release binary first
cargo build --release

# Then run the same operations manually, e.g.:
time target/release/xcert show tests/certs/server.pem > /dev/null
time target/release/xcert field fingerprint tests/certs/server.pem > /dev/null
time target/release/xcert check host www.example.com tests/certs/server.pem
```

Detailed OpenSSL baseline data is in [`docs/performance-baseline.md`](docs/performance-baseline.md).

## Fuzzing

The project includes [cargo-fuzz](https://github.com/rust-fuzz/cargo-fuzz)
targets for coverage-guided fuzzing with libFuzzer.

```bash
# Install cargo-fuzz (requires nightly)
rustup install nightly
cargo install cargo-fuzz

# List targets
cargo +nightly fuzz list
# parse_cert, parse_der, parse_pem, roundtrip

# Run a fuzz target
cargo +nightly fuzz run parse_cert -- -max_total_time=60

# Run with the included ASN.1 dictionary for better coverage
cargo +nightly fuzz run parse_cert -- -max_total_time=300 -dict=fuzz/x509.dict
```

Seed corpus files are pre-populated from the test certificates.

## Security

- `unsafe` code is **denied** at the workspace level
- Clippy warns on `unwrap()`, `expect()`, `panic!()`, and array indexing
- 13 degenerate/malformed certificate test vectors exercise error paths
- 4 fuzz targets for continuous testing of parsing robustness
- `cargo-audit` is supported for dependency vulnerability scanning:
  `cargo install cargo-audit && cargo audit`

## Project structure

```
xcert-rs/
  xcert-lib/          # Library crate (parsing, display, checks, verification)
    src/
      lib.rs          # Public API
      parser.rs       # PEM/DER parsing, CertificateInfo construction
      fields.rs       # Data types (CertificateInfo, extensions, etc.)
      verify.rs       # Certificate chain verification and trust store
      fingerprint.rs  # SHA-256/384/512/SHA-1 fingerprints
      display.rs      # Human-readable text and JSON output
      check.rs        # Expiry, hostname, email, IP checks
      convert.rs      # PEM <-> DER conversion
      util.rs         # Shared encoding utilities
    tests/
      integration.rs  # 155 integration tests
  xcert/              # CLI binary crate
    src/main.rs       # clap-based CLI with subcommands
  fuzz/               # cargo-fuzz targets and corpus
  bench/              # Benchmark scripts
  tests/certs/        # Test certificates (PEM, DER, degenerate, real chains)
  docs/               # Design documents and reference
```

## License

This project is licensed under the [MIT License](LICENSE).
